name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.13']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Qt dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libxcb-xinerama0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-shape0 \
          libxcb-cursor0 \
          libxkbcommon-x11-0 \
          libegl1 \
          libdbus-1-3 \
          libxcb-xfixes0

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements*.txt', 'pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Pillow>=10.0.0 qrcode[pil]>=7.4.0 PyQt6>=6.6.0
        pip install -e .
        pip install pytest pyinstaller

    - name: Run tests
      run: |
        pytest tests/ -v

    - name: Test imports
      run: |
        python -c "from qrly import __version__; print(f'Version: {__version__}')"
        python -c "from qrly.app import SimpleMainWindow; print('GUI imports successful')"
        python -c "from qrly.generator import QRModelGenerator; print('Generator imports successful')"

  build-check:
    name: Build Check on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: test

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Pillow>=10.0.0 qrcode[pil]>=7.4.0 PyQt6>=6.6.0
        pip install -e .
        pip install pyinstaller

    - name: Clean previous builds
      shell: bash
      run: |
        rm -rf dist build

    - name: Build with PyInstaller (macOS)
      if: runner.os == 'macOS'
      run: |
        pyinstaller qrly.spec --clean --noconfirm
        ls -la dist/

    - name: Build with PyInstaller (Linux)
      if: runner.os == 'Linux'
      run: |
        pyinstaller qrly.spec --clean --noconfirm
        ls -la dist/

    - name: Build with PyInstaller (Windows)
      if: runner.os == 'Windows'
      run: |
        pyinstaller qrly.spec --clean --noconfirm
        dir dist\

    - name: Verify build output (macOS)
      if: runner.os == 'macOS'
      run: |
        test -f dist/Qrly/Qrly || exit 1
        echo "macOS executable created successfully"

    - name: Verify build output (Linux)
      if: runner.os == 'Linux'
      run: |
        test -f dist/Qrly/Qrly || exit 1
        echo "Linux executable created successfully"

    - name: Verify build output (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        if (!(Test-Path "dist\Qrly\Qrly.exe")) { exit 1 }
        Write-Host "Windows executable created successfully"
