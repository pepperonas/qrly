name: Release Build with OpenSCAD

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.3.0, v1.0.0, etc.
  workflow_dispatch:  # Allow manual trigger

# Required permissions for creating releases and uploading assets
permissions:
  contents: write

env:
  OPENSCAD_VERSION: "2025.01.24"
  APP_VERSION: "0.3.0"

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        else
          echo "version=${{ env.APP_VERSION }}" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Qrly v${{ steps.get_version.outputs.version }}
        draft: false
        prerelease: false
        body: |
          ## Qrly - QR Code 3D Generator v${{ steps.get_version.outputs.version }}

          Generate 3D-printable QR code models from URLs or images.

          ### ‚ú® What's New

          - ‚ö° **Fast rendering**: OpenSCAD 2025 with fast-csg + Manifold engine (~1 second per model)
          - üì¶ **Native installers**: DMG for macOS, EXE installer for Windows, AppImage for Linux
          - üéØ **Text modes**: Add custom text labels to your QR codes
          - üîÑ **Batch processing**: Generate multiple models from JSON config
          - üñºÔ∏è **Professional icons**: Beautiful app icons on all platforms

          ### üì• Downloads

          Choose the installer for your operating system:

          | Platform | File | Installation |
          |----------|------|--------------|
          | **macOS** | `Qrly-${{ steps.get_version.outputs.version }}-macOS.dmg` | 1. Drag to Applications<br/>2. Run: `xattr -cr /Applications/Qrly.app`<br/>3. Install OpenSCAD: `brew install openscad` |
          | **Windows** | `Qrly-${{ steps.get_version.outputs.version }}-Windows-Setup.exe` | Run installer (includes OpenSCAD) |
          | **Linux** | `Qrly-${{ steps.get_version.outputs.version }}-Linux.AppImage` | `chmod +x *.AppImage`, then run<br/>**Requires**: `sudo apt install openscad` |

          ### üéØ Features

          - **4 Modes**: Square, Pendant, Rectangle+Text, Pendant+Text
          - **Text Labels**: Add up to 20 characters under QR code (auto-scaled 3-6mm)
          - **Credit Card Size**: 55x55mm base (ISO 7810 standard)
          - **Easy Setup**: Windows bundles OpenSCAD; macOS/Linux: quick install via package manager
          - **Batch Generation**: Process multiple QR codes from JSON config
          - **Drag & Drop**: Load previous settings from JSON metadata files

          ### üìñ Quick Start

          1. **Install OpenSCAD** (if needed):
             - macOS: `brew install openscad`
             - Windows: Bundled with installer
             - Linux: `sudo apt install openscad`
          2. Download and install Qrly for your platform
          3. **macOS only:** Remove quarantine flag: `xattr -cr /Applications/Qrly.app`
          4. Enter a URL or select an image file
          5. Choose mode and adjust parameters
          6. Click "Generate STL" - done in ~1 second!

          ### üîß System Requirements

          - **macOS**: 10.13+ (High Sierra or later)
          - **Windows**: Windows 10+ (64-bit)
          - **Linux**: Most modern distributions (x86_64)

          ### üìù Documentation

          - [README](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Installation Guide](https://github.com/${{ github.repository }}/blob/main/INSTALL.md)

          ---

          **Important Notes:**

          - **macOS Security:** The app is unsigned. After installation, run `xattr -cr /Applications/Qrly.app` to remove the quarantine flag, or right-click ‚Üí Open ‚Üí Open to bypass Gatekeeper.
          - **Windows:** OpenSCAD 2025.01.24 is bundled with the installer
          - **macOS/Linux:** Requires separate OpenSCAD installation via package manager

          üìñ **Full installation guide:** [INSTALL.md](https://github.com/${{ github.repository }}/blob/main/INSTALL.md)

          _Built with ‚ù§Ô∏è using Python 3.13, PyQt6, and OpenSCAD 2025_
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS (OpenSCAD not bundled)
    needs: create-release
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install only required packages, NOT dev dependencies
        pip install Pillow "qrcode[pil]" PyQt6
        pip install py2app

    - name: Copy py2app setup script
      run: |
        cp setup_py2app.py setup.py

    - name: Build with py2app
      run: |
        echo "Building Qrly with py2app..."
        python setup.py py2app
        echo "‚úì Build completed!"
        ls -la dist/

    - name: Install create-dmg
      run: |
        brew install create-dmg

    - name: Create DMG installer
      run: |
        mkdir -p dist/dmg
        cp -R dist/Qrly.app dist/dmg/

        # Create a nice DMG with create-dmg
        # Check if icon exists in the bundle
        if [ -f "dist/Qrly.app/Contents/Resources/app_icon.icns" ]; then
          ICON_ARG="--volicon dist/Qrly.app/Contents/Resources/app_icon.icns"
        else
          ICON_ARG=""
        fi

        create-dmg \
          --volname "Qrly Installer" \
          $ICON_ARG \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "Qrly.app" 200 190 \
          --hide-extension "Qrly.app" \
          --app-drop-link 600 185 \
          --no-internet-enable \
          "dist/Qrly-${{ needs.create-release.outputs.version }}-macOS.dmg" \
          "dist/dmg/" || \
        # Fallback if create-dmg fails
        hdiutil create -volname "Qrly Installer" -srcfolder dist/dmg -ov -format UDZO \
          "dist/Qrly-${{ needs.create-release.outputs.version }}-macOS.dmg"

    - name: Upload macOS DMG
      uses: softprops/action-gh-release@v1
      with:
        files: dist/Qrly-${{ needs.create-release.outputs.version }}-macOS.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-windows:
    name: Build Windows with OpenSCAD
    needs: create-release
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Download OpenSCAD 2025
      shell: pwsh
      run: |
        Write-Host "Downloading OpenSCAD ${{ env.OPENSCAD_VERSION }} for Windows..."

        # Download latest snapshot from files.openscad.org
        $url = "https://files.openscad.org/snapshots/OpenSCAD-${{ env.OPENSCAD_VERSION }}-x86-64.zip"
        Invoke-WebRequest -Uri $url -OutFile openscad.zip

        # Extract to openscad_bundle
        Expand-Archive -Path openscad.zip -DestinationPath openscad_temp -Force

        # Flatten directory structure (remove OpenSCAD-VERSION directory)
        New-Item -ItemType Directory -Path openscad_bundle -Force
        $scadDir = Get-ChildItem -Path openscad_temp -Directory | Select-Object -First 1
        if ($scadDir) {
          Move-Item -Path "$($scadDir.FullName)\*" -Destination openscad_bundle -Force
          Remove-Item -Path openscad_temp -Recurse -Force
        }

        Remove-Item openscad.zip
        Write-Host "‚úì OpenSCAD extracted to openscad_bundle/"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Pillow>=10.0.0 qrcode[pil]>=7.4.0 PyQt6>=6.6.0
        pip install -e .
        pip install pyinstaller

    - name: Build with PyInstaller
      run: |
        pyinstaller qrly.spec --clean --noconfirm
        dir dist\

    - name: Install NSIS
      shell: pwsh
      run: |
        choco install nsis -y

    - name: Create NSIS installer script
      shell: pwsh
      run: |
        $version = "${{ needs.create-release.outputs.version }}"
        $nsiScript = @"
        !define APP_NAME "Qrly"
        !define APP_VERSION "$version"
        !define PUBLISHER "Qrly Project"
        !define WEB_SITE "https://github.com/${{ github.repository }}"
        !define APP_EXE "Qrly.exe"

        Name "`${APP_NAME}"
        OutFile "dist\Qrly-`${APP_VERSION}-Windows-Setup.exe"
        InstallDir "`$PROGRAMFILES64\`${APP_NAME}"
        RequestExecutionLevel admin

        !include "MUI2.nsh"

        !define MUI_ABORTWARNING
        !define MUI_ICON "`${NSISDIR}\Contrib\Graphics\Icons\modern-install.ico"
        !define MUI_UNICON "`${NSISDIR}\Contrib\Graphics\Icons\modern-uninstall.ico"

        !insertmacro MUI_PAGE_WELCOME
        !insertmacro MUI_PAGE_LICENSE "LICENSE"
        !insertmacro MUI_PAGE_DIRECTORY
        !insertmacro MUI_PAGE_INSTFILES
        !insertmacro MUI_PAGE_FINISH

        !insertmacro MUI_UNPAGE_CONFIRM
        !insertmacro MUI_UNPAGE_INSTFILES

        !insertmacro MUI_LANGUAGE "English"

        Section "Install"
          SetOutPath "`$INSTDIR"
          File /r "dist\Qrly\*.*"

          CreateDirectory "`$SMPROGRAMS\`${APP_NAME}"
          CreateShortcut "`$SMPROGRAMS\`${APP_NAME}\`${APP_NAME}.lnk" "`$INSTDIR\`${APP_EXE}"
          CreateShortcut "`$DESKTOP\`${APP_NAME}.lnk" "`$INSTDIR\`${APP_EXE}"

          WriteUninstaller "`$INSTDIR\Uninstall.exe"

          WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "DisplayName" "`${APP_NAME}"
          WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "UninstallString" "`$INSTDIR\Uninstall.exe"
          WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "DisplayVersion" "`${APP_VERSION}"
          WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "Publisher" "`${PUBLISHER}"
          WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}" "URLInfoAbout" "`${WEB_SITE}"
        SectionEnd

        Section "Uninstall"
          Delete "`$INSTDIR\Uninstall.exe"
          RMDir /r "`$INSTDIR"

          Delete "`$SMPROGRAMS\`${APP_NAME}\*.*"
          RMDir "`$SMPROGRAMS\`${APP_NAME}"
          Delete "`$DESKTOP\`${APP_NAME}.lnk"

          DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\`${APP_NAME}"
        SectionEnd
        "@

        Set-Content -Path "installer.nsi" -Value $nsiScript

    - name: Build installer
      shell: pwsh
      run: |
        & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi

    - name: Upload Windows Installer
      uses: softprops/action-gh-release@v1
      with:
        files: dist/Qrly-${{ needs.create-release.outputs.version }}-Windows-Setup.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    name: Build Linux (OpenSCAD not bundled)
    needs: create-release
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libxcb-xinerama0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
          libxcb-randr0 libxcb-render-util0 libxcb-shape0 libxcb-cursor0 \
          libxkbcommon-x11-0 libegl1 libdbus-1-3 libxcb-xfixes0 \
          fuse libfuse2 file

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install Pillow>=10.0.0 qrcode[pil]>=7.4.0 PyQt6>=6.6.0
        pip install -e .
        pip install pyinstaller

    - name: Build with PyInstaller
      run: |
        echo "Building Qrly (OpenSCAD not bundled - users install separately)"
        pyinstaller qrly.spec --clean --noconfirm
        ls -la dist/

    - name: Download linuxdeploy and appimagetool
      run: |
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage appimagetool-x86_64.AppImage

    - name: Create AppImage
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

        # Copy application files
        cp -r dist/Qrly/* AppDir/usr/bin/

        # Copy icon if available
        if [ -f "assets/icons/linux/icon_256x256.png" ]; then
          cp assets/icons/linux/icon_256x256.png AppDir/usr/share/icons/hicolor/256x256/apps/qrly.png
        fi

        # Create desktop entry
        cat > AppDir/usr/share/applications/qrly.desktop <<EOF
        [Desktop Entry]
        Type=Application
        Name=Qrly
        Comment=QR Code 3D Generator
        Exec=Qrly
        Icon=qrly
        Categories=Graphics;Utility;
        Terminal=false
        EOF

        # Make AppImage
        ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir dist/Qrly-${{ needs.create-release.outputs.version }}-Linux.AppImage

    - name: Upload Linux AppImage
      uses: softprops/action-gh-release@v1
      with:
        files: dist/Qrly-${{ needs.create-release.outputs.version }}-Linux.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
