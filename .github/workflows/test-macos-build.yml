name: Test macOS Build

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches:
      - test-macos  # Only on test branch

permissions:
  contents: write

env:
  OPENSCAD_VERSION: "2025.01.24"

jobs:
  test-macos:
    name: Test macOS Build with OpenSCAD
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller

    - name: Clean previous builds
      run: |
        rm -rf dist build

    - name: Build with PyInstaller
      run: |
        echo "Building Qrly with PyInstaller BUNDLE (produces dist/Qrly.app)..."
        echo "PyInstaller BUNDLE handles all frameworks automatically"
        echo "Users will install OpenSCAD separately: brew install openscad"
        pyinstaller qrly.spec --clean --noconfirm
        echo "Build completed!"
        ls -la dist/

    - name: Verify app structure
      run: |
        echo "Verifying PyInstaller BUNDLE .app structure..."
        ls -la dist/Qrly.app/Contents/
        echo ""
        echo "Checking Frameworks (should contain Python and Qt):"
        ls -la dist/Qrly.app/Contents/Frameworks/ | grep -E "Python|Qt" | head -10
        echo ""
        echo "Checking Resources:"
        ls -la dist/Qrly.app/Contents/Resources/ | head -10
        echo ""
        echo "Checking MacOS directory:"
        ls -la dist/Qrly.app/Contents/MacOS/

    - name: Create DMG installer
      run: |
        brew install create-dmg

        mkdir -p dist/dmg
        cp -R dist/Qrly.app dist/dmg/

        # Create DMG
        create-dmg \
          --volname "Qrly Test Installer" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "Qrly.app" 200 190 \
          --hide-extension "Qrly.app" \
          --app-drop-link 600 185 \
          "dist/Qrly-test-macOS.dmg" \
          "dist/dmg/" || \
        hdiutil create -volname "Qrly Test" -srcfolder dist/dmg -ov -format UDZO \
          "dist/Qrly-test-macOS.dmg"

        echo "âœ“ DMG created!"
        ls -lh dist/Qrly-test-macOS.dmg

    - name: Upload DMG as artifact
      uses: actions/upload-artifact@v4
      with:
        name: Qrly-test-macOS
        path: dist/Qrly-test-macOS.dmg
        retention-days: 7

    - name: Upload full app bundle as artifact
      uses: actions/upload-artifact@v4
      with:
        name: Qrly-app-bundle
        path: dist/Qrly.app
        retention-days: 7
