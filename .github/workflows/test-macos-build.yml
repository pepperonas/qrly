name: Test macOS Build

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches:
      - test-macos  # Only on test branch

permissions:
  contents: write

env:
  OPENSCAD_VERSION: "2025.01.24"

jobs:
  test-macos:
    name: Test macOS Build with OpenSCAD
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pyinstaller

    - name: Clean previous builds
      run: |
        rm -rf dist build

    - name: Build with PyInstaller (without OpenSCAD bundle)
      run: |
        echo "Building Qrly with PyInstaller (produces dist/Qrly folder)..."
        echo "Users will install OpenSCAD separately: brew install openscad"
        pyinstaller qrly.spec --clean --noconfirm
        echo "Build completed!"
        ls -la dist/

    - name: Bundle Qt frameworks manually
      run: |
        echo "Manually bundling Qt frameworks (dereferencing symlinks)..."

        # Find PyQt6 Qt6 directory
        PYQT6_DIR=$(python -c "import PyQt6; import os; print(os.path.join(os.path.dirname(PyQt6.__file__), 'Qt6'))")
        echo "PyQt6 Qt6 directory: $PYQT6_DIR"

        # Create directory for frameworks in dist/Qrly/_internal (PyInstaller structure)
        mkdir -p dist/Qrly/_internal/PyQt6/Qt6/lib

        # Copy required Qt frameworks, dereferencing symlinks (-L flag)
        echo "Copying QtCore.framework..."
        cp -RL "$PYQT6_DIR/lib/QtCore.framework" dist/Qrly/_internal/PyQt6/Qt6/lib/ || echo "QtCore copy failed, continuing..."

        echo "Copying QtWidgets.framework..."
        cp -RL "$PYQT6_DIR/lib/QtWidgets.framework" dist/Qrly/_internal/PyQt6/Qt6/lib/ || echo "QtWidgets copy failed, continuing..."

        echo "Copying QtGui.framework..."
        cp -RL "$PYQT6_DIR/lib/QtGui.framework" dist/Qrly/_internal/PyQt6/Qt6/lib/ || echo "QtGui copy failed, continuing..."

        echo "Copying QtDBus.framework (required by QtWidgets)..."
        cp -RL "$PYQT6_DIR/lib/QtDBus.framework" dist/Qrly/_internal/PyQt6/Qt6/lib/ || echo "QtDBus copy failed, continuing..."

        echo "✓ Qt frameworks copied with symlinks dereferenced"
        ls -la dist/Qrly/_internal/PyQt6/Qt6/lib/

    - name: Manually create .app bundle
      run: |
        echo "Creating Qrly.app structure manually (PyInstaller BUNDLE disabled due to Qt symlink issues)..."

        # Create .app directory structure
        mkdir -p dist/Qrly.app/Contents/MacOS
        mkdir -p dist/Qrly.app/Contents/Resources

        # Copy all files from dist/Qrly to Contents/MacOS
        cp -R dist/Qrly/* dist/Qrly.app/Contents/MacOS/

        # Create Frameworks directory and Python symlink (required by PyInstaller)
        mkdir -p dist/Qrly.app/Contents/Frameworks
        ln -s ../MacOS/_internal/Python.framework/Versions/3.13/Python dist/Qrly.app/Contents/Frameworks/Python
        echo "✓ Created Frameworks/Python symlink"

        # Copy icon
        if [ -f "assets/icons/app_icon.icns" ]; then
          cp assets/icons/app_icon.icns dist/Qrly.app/Contents/Resources/
        fi

        # Create Info.plist
        cat > dist/Qrly.app/Contents/Info.plist <<EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleName</key>
            <string>Qrly</string>
            <key>CFBundleDisplayName</key>
            <string>Qrly - QR Code 3D Generator</string>
            <key>CFBundleIdentifier</key>
            <string>com.qrly.app</string>
            <key>CFBundleVersion</key>
            <string>0.3.0</string>
            <key>CFBundleShortVersionString</key>
            <string>0.3.0</string>
            <key>CFBundleExecutable</key>
            <string>Qrly</string>
            <key>CFBundleIconFile</key>
            <string>app_icon</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>NSHighResolutionCapable</key>
            <true/>
            <key>LSMinimumSystemVersion</key>
            <string>10.13.0</string>
        </dict>
        </plist>
        EOF

        # Make executable
        chmod +x dist/Qrly.app/Contents/MacOS/Qrly

        echo "✓ Qrly.app created successfully"
        ls -la dist/

    - name: Verify app structure
      run: |
        echo "Verifying Qrly.app structure..."
        ls -la dist/Qrly.app/Contents/
        echo ""
        echo "Checking for executable:"
        ls -la dist/Qrly.app/Contents/MacOS/
        echo ""
        echo "Checking for icon:"
        ls -la dist/Qrly.app/Contents/Resources/ | grep -i icon || echo "No icon found"

    - name: Create DMG installer
      run: |
        brew install create-dmg

        mkdir -p dist/dmg
        cp -R dist/Qrly.app dist/dmg/

        # Create DMG
        create-dmg \
          --volname "Qrly Test Installer" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "Qrly.app" 200 190 \
          --hide-extension "Qrly.app" \
          --app-drop-link 600 185 \
          "dist/Qrly-test-macOS.dmg" \
          "dist/dmg/" || \
        hdiutil create -volname "Qrly Test" -srcfolder dist/dmg -ov -format UDZO \
          "dist/Qrly-test-macOS.dmg"

        echo "✓ DMG created!"
        ls -lh dist/Qrly-test-macOS.dmg

    - name: Upload DMG as artifact
      uses: actions/upload-artifact@v4
      with:
        name: Qrly-test-macOS
        path: dist/Qrly-test-macOS.dmg
        retention-days: 7

    - name: Upload full app bundle as artifact
      uses: actions/upload-artifact@v4
      with:
        name: Qrly-app-bundle
        path: dist/Qrly.app
        retention-days: 7
